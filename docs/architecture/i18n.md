# Internationalization (i18n) Architecture

## Overview

Arcanine implements a custom internationalization system built on Svelte stores, providing type-safe translations with parameter interpolation, locale persistence, and comprehensive formatting utilities.

## Table of Contents

1. [System Architecture](#system-architecture)
2. [Supported Languages](#supported-languages)
3. [Translation System](#translation-system)
4. [API Reference](#api-reference)
5. [Translation Files](#translation-files)
6. [Usage Examples](#usage-examples)
7. [Formatting Utilities](#formatting-utilities)
8. [Best Practices](#best-practices)
9. [Testing](#testing)
10. [Adding New Languages](#adding-new-languages)

---

## System Architecture

### Core Components

```
src/lib/i18n/
‚îú‚îÄ‚îÄ index.ts                 # Core i18n system, stores, and utilities
‚îú‚îÄ‚îÄ index.test.ts            # Comprehensive test suite
‚îî‚îÄ‚îÄ locales/
    ‚îú‚îÄ‚îÄ en.json              # English translations
    ‚îú‚îÄ‚îÄ es.json              # Spanish translations
    ‚îú‚îÄ‚îÄ fr.json              # French translations
    ‚îú‚îÄ‚îÄ de.json              # German translations
    ‚îî‚îÄ‚îÄ ja.json              # Japanese translations
```

### Key Features

- **Type-Safe**: Full TypeScript support with type definitions
- **Reactive**: Built on Svelte stores for automatic UI updates
- **Persistent**: Saves user language preference to localStorage
- **Nested Keys**: Support for deeply nested translation keys
- **Parameter Interpolation**: Dynamic parameter replacement in translations
- **Fallback System**: Falls back to English if translations are missing
- **Browser Detection**: Auto-detects browser language on first load
- **Formatting Utilities**: Built-in number, date, and file size formatting

---

## Supported Languages

Arcanine currently supports 5 languages:

| Code | Language | Native Name | Flag |
| ---- | -------- | ----------- | ---- |
| `en` | English  | English     | üá¨üáß   |
| `es` | Spanish  | Espa√±ol     | üá™üá∏   |
| `fr` | French   | Fran√ßais    | üá´üá∑   |
| `de` | German   | Deutsch     | üá©üá™   |
| `ja` | Japanese | Êó•Êú¨Ë™û      | üáØüáµ   |

### Language Metadata

Access language metadata via `localeInfo`:

```typescript
import { localeInfo } from '$lib/i18n';

console.log(localeInfo.es);
// {
//   code: 'es',
//   name: 'Spanish',
//   nativeName: 'Espa√±ol',
//   flag: 'üá™üá∏'
// }
```

---

## Translation System

### Store Architecture

The i18n system uses three main Svelte stores:

#### 1. `locale` (Writable<string>)

Holds the current locale code:

```typescript
import { locale } from '$lib/i18n';
import { get } from 'svelte/store';

console.log(get(locale)); // 'en'
locale.set('es'); // Switch to Spanish
```

#### 2. `translations` (Writable<Record<string, Translations>>)

Stores all loaded translations:

```typescript
{
  en: { app: { name: 'Arcanine' } },
  es: { app: { name: 'Arcanine' } }
}
```

#### 3. `t` (Readable<TranslationFunction>)

Derived store providing the translation function:

```typescript
import { t } from '$lib/i18n';

const translate = get(t);
translate('app.name'); // Returns: 'Arcanine'
```

### Translation Keys

#### Simple Keys

```json
{
  "cancel": "Cancel",
  "save": "Save"
}
```

Usage:

```svelte
<button>{$t('actions.cancel')}</button>
```

#### Nested Keys

```json
{
  "request": {
    "methods": {
      "get": "GET",
      "post": "POST"
    }
  }
}
```

Usage:

```svelte
<span>{$t('request.methods.get')}</span>
```

#### Parameter Interpolation

Parameters use `{paramName}` syntax:

```json
{
  "greeting": "Hello, {name}!",
  "itemCount": "You have {count} items"
}
```

Usage:

```svelte
<p>{$t('greeting', { name: 'Alice' })}</p><p>{$t('itemCount', { count: 5 })}</p>
```

---

## API Reference

### Core Functions

#### `loadTranslations(localeCode: string): Promise<void>`

Loads translation file for specified locale:

```typescript
await loadTranslations('es');
```

- **Error Handling**: Falls back to English if loading fails
- **Caching**: Stores loaded translations in the `translations` store

#### `setLocale(localeCode: string): Promise<void>`

Sets the current locale and loads its translations:

```typescript
await setLocale('fr');
```

- **Validation**: Only accepts valid locale codes from `availableLocales`
- **Persistence**: Saves selection to localStorage
- **Reactive**: Triggers UI updates via store subscription

#### `initializeI18n(): Promise<void>`

Initializes the i18n system on app load:

```typescript
import { onMount } from 'svelte';
import { initializeI18n } from '$lib/i18n';

onMount(async () => {
  await initializeI18n();
});
```

**Initialization Logic:**

1. Check localStorage for saved locale
2. If not found, check browser language
3. If browser language unsupported, default to English
4. Load translations for selected locale

---

## Translation Files

### File Structure

All translation files follow the same structure:

```json
{
  "app": {
    "name": "Application Name",
    "description": "Description text"
  },
  "actions": {
    "save": "Save",
    "cancel": "Cancel"
  },
  "common": {
    "name": "Name",
    "description": "Description"
  }
}
```

### Key Categories

#### 1. Application (`app`)

- Application name, description, version info
- General UI messages (loading, welcome, no data)

#### 2. Menu (`menu`)

- Main menu items
- Submenu labels

#### 3. Actions (`actions`)

- Common action buttons
- CRUD operations
- File operations

#### 4. Common (`common`)

- Frequently used terms
- Status labels
- Generic UI text

#### 5. Requests (`request`)

- HTTP method names
- Request-related labels
- Body types, auth types

#### 6. Collections (`collection`)

- Collection management
- Folder operations

#### 7. Errors (`errors`)

- Error messages
- Network errors
- Validation errors

#### 8. Validation (`validation`)

- Form validation messages
- Field requirements

#### 9. Settings (`settings`)

- Configuration options
- Preference labels

#### 10. Language & Theme (`language`, `theme`)

- Language switcher labels
- Theme options

---

## Usage Examples

### In Svelte Components

#### Basic Usage

```svelte
<script lang="ts">
  import { t } from '$lib/i18n';
</script>

<h1>{$t('app.name')}</h1><p>{$t('app.description')}</p>
```

#### With Parameters

```svelte
<script lang="ts">
  import { t } from '$lib/i18n';
  let username = 'Alice';
</script>

<p>{$t('greeting', { name: username })}</p>
```

#### Dynamic Keys

```svelte
<script lang="ts">
  import { t } from '$lib/i18n';
  let method = 'GET';
</script>

<span>{$t(`request.methods.${method.toLowerCase()}`)}</span>
```

### In TypeScript/JavaScript

```typescript
import { get } from 'svelte/store';
import { t, setLocale } from '$lib/i18n';

// Get translation
const translate = get(t);
const message = translate('errors.network');

// Change language
await setLocale('es');
```

### Language Switcher Component

The `LanguageSwitcher` component provides a complete UI for language selection:

```svelte
<script lang="ts">
  import LanguageSwitcher from '$lib/components/LanguageSwitcher.svelte';
</script>

<LanguageSwitcher />
```

**Features:**

- Dropdown menu with all available languages
- Flag emojis for visual identification
- Native and English language names
- Keyboard navigation support
- ARIA labels for accessibility
- Auto-closes on selection
- Persists selection to localStorage

---

## Formatting Utilities

### Number Formatting

Format numbers according to locale conventions:

```typescript
import { formatNumber } from '$lib/i18n';

formatNumber(1234.56);
// en: '1,234.56'
// de: '1.234,56'

formatNumber(1234.56, {
  style: 'currency',
  currency: 'USD',
});
// en: '$1,234.56'
```

**Options**: Accepts all `Intl.NumberFormatOptions`

### Date Formatting

Format dates according to locale:

```typescript
import { formatDate } from '$lib/i18n';

const date = new Date('2024-01-15');

formatDate(date);
// en: '1/15/2024'
// de: '15.1.2024'

formatDate(date, {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});
// en: 'January 15, 2024'
// es: '15 de enero de 2024'
```

**Input Types:** Accepts `Date`, `string`, or `number` (timestamp)

### Relative Time Formatting

Format time relative to now:

```typescript
import { formatRelativeTime } from '$lib/i18n';

const twoHoursAgo = new Date(Date.now() - 2 * 60 * 60 * 1000);

formatRelativeTime(twoHoursAgo);
// en: '2 hours ago'
// es: 'hace 2 horas'
// ja: '2 ÊôÇÈñìÂâç'
```

**Time Units:** Automatically selects appropriate unit (seconds, minutes, hours, days)

### File Size Formatting

Format byte counts in human-readable format:

```typescript
import { formatFileSize } from '$lib/i18n';

formatFileSize(0); // '0 Bytes'
formatFileSize(1024); // '1 KB'
formatFileSize(1048576); // '1 MB'
formatFileSize(1536, 2); // '1.50 KB'
formatFileSize(1536, 0); // '2 KB'
```

**Parameters:**

- `bytes`: Number of bytes
- `decimals`: Decimal places (default: 2)

### Pluralization

Simple pluralization helper:

```typescript
import { pluralize } from '$lib/i18n';

pluralize(1, 'item'); // 'item'
pluralize(0, 'item'); // 'items'
pluralize(5, 'item'); // 'items'
pluralize(2, 'person', 'people'); // 'people'
```

---

## Best Practices

### 1. Translation Key Naming

**Use dot notation for hierarchy:**

```
‚úÖ request.method.get
‚ùå requestMethodGet
```

**Be specific:**

```
‚úÖ errors.network.timeout
‚ùå error1
```

**Group related keys:**

```
‚úÖ actions.save, actions.cancel, actions.delete
‚ùå save, cancel, delete (ungrouped)
```

### 2. Parameter Naming

**Use descriptive names:**

```
‚úÖ {username}, {itemCount}, {fileName}
‚ùå {x}, {var1}, {temp}
```

**Keep names consistent:**

```json
{
  "greeting": "Hello, {name}!",
  "farewell": "Goodbye, {name}!"
}
```

### 3. Missing Translations

**Always provide fallback:**

```typescript
const text = $t('possibly.missing.key') || 'Default Text';
```

**Monitor console warnings:**

```
Translation missing for key: some.key in locale: es
```

### 4. Performance

**Lazy load translations:**

```typescript
// Only load when needed
async function switchLanguage(locale: string) {
  await setLocale(locale);
}
```

**Avoid repeated translation calls:**

```svelte
<!-- ‚úÖ Good -->
<script>
  const itemLabel = $t('common.item');
</script>

<!-- ‚ùå Bad -->
{#each items as item}
  <div>{$t('common.item')}: {item.name}</div>
{/each}
{#each items as item}
  <div>{itemLabel}: {item.name}</div>
{/each}
```

### 5. Accessibility

**Provide translations for ARIA labels:**

```svelte
<button aria-label={$t('accessibility.closeDialog')}> √ó </button>
```

**Include screen reader text:**

```svelte
<span aria-hidden="true">{flag}</span>
<span class="sr-only">{$t('language.current')}: {nativeName}</span>
```

---

## Testing

### Unit Tests

Test translations in isolation:

```typescript
import { describe, it, expect } from 'vitest';
import { get } from 'svelte/store';
import { t, setLocale, loadTranslations } from '$lib/i18n';

describe('Translations', () => {
  it('translates app name', async () => {
    await loadTranslations('en');
    const translate = get(t);
    expect(translate('app.name')).toBe('Arcanine');
  });

  it('handles parameters', async () => {
    await loadTranslations('en');
    const translate = get(t);
    expect(translate('greeting', { name: 'Test' })).toBe('Hello, Test!');
  });
});
```

### Component Tests

Test language switching in components:

```typescript
import { describe, it, expect } from 'vitest';
import { setLocale } from '$lib/i18n';

describe('LanguageSwitcher', () => {
  it('switches language', async () => {
    await setLocale('es');
    expect(get(locale)).toBe('es');
  });
});
```

### E2E Tests

Test full language switching flow:

```typescript
test('User can switch languages', async ({ page }) => {
  await page.goto('/');
  await page.click('[aria-label="Select language"]');
  await page.click('text=Espa√±ol');
  await expect(page.locator('h1')).toHaveText('Arcanine');
});
```

---

## Adding New Languages

### Step 1: Add Locale Code

Update `availableLocales` in `src/lib/i18n/index.ts`:

```typescript
export const availableLocales = [
  'en',
  'es',
  'fr',
  'de',
  'ja',
  'pt', // Add Portuguese
] as const;
```

### Step 2: Add Locale Metadata

Update `localeInfo` in `src/lib/i18n/index.ts`:

```typescript
export const localeInfo: Record<Locale, LocaleInfo> = {
  // ... existing locales
  pt: {
    code: 'pt',
    name: 'Portuguese',
    nativeName: 'Portugu√™s',
    flag: 'üáµüáπ',
  },
};
```

### Step 3: Create Translation File

Create `src/lib/i18n/locales/pt.json`:

```json
{
  "app": {
    "name": "Arcanine",
    "description": "Um cliente REST API moderno, offline"
  }
  // ... copy structure from en.json and translate
}
```

### Step 4: Test the Translation

```typescript
await setLocale('pt');
console.log(get(t)('app.name')); // Should work
```

### Step 5: Update Documentation

Add the new language to this document's [Supported Languages](#supported-languages) section.

---

## Troubleshooting

### Common Issues

#### Translation Not Showing

**Problem:** Key returns itself instead of translation

**Solutions:**

1. Check key spelling and nesting
2. Verify translation exists in locale file
3. Ensure locale file is valid JSON
4. Check console for warnings

#### Language Not Persisting

**Problem:** Language resets on page reload

**Solutions:**

1. Check localStorage permissions
2. Verify `setLocale()` is being called
3. Check for localStorage quota issues

#### Parameters Not Replacing

**Problem:** `{paramName}` appears in output

**Solutions:**

1. Verify parameter name matches exactly
2. Check parameter is being passed
3. Ensure parameter value is not undefined

---

## Performance Considerations

### Translation Loading

- Translations are loaded on-demand via `setLocale()`
- Each locale is loaded only once and cached
- JSON files are bundled at build time

### Store Subscriptions

- Use `$t('key')` in templates for automatic reactivity
- Use `get(t)` in scripts for one-time reads
- Unsubscribe from stores in `onDestroy` if manually subscribing

### Bundle Size

Current translation file sizes:

- English (en.json): ~15KB
- Spanish (es.json): ~16KB
- French (fr.json): ~17KB
- German (de.json): ~16KB
- Japanese (ja.json): ~18KB

**Total:** ~82KB uncompressed, ~20KB gzipped

---

## Future Enhancements

Potential improvements for future versions:

1. **Advanced Pluralization**
   - Support for complex plural rules (CLDR)
   - Gender-specific translations

2. **RTL Language Support**
   - Right-to-left text direction
   - Mirrored layouts for Arabic, Hebrew

3. **Translation Management**
   - Admin UI for editing translations
   - Export/import for translation services

4. **Context-Aware Translations**
   - Different translations based on context
   - Formal vs. informal variants

5. **Translation Coverage**
   - Tool to detect missing keys
   - Coverage percentage per locale

---

## References

- [Svelte Stores Documentation](https://svelte.dev/docs#run-time-svelte-store)
- [Intl API (MDN)](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Intl)
- [BCP 47 Language Tags](https://www.rfc-editor.org/rfc/bcp/bcp47.txt)
- [Unicode CLDR](https://cldr.unicode.org/)

---

**Last Updated:** Phase 3.2 (December 2024)  
**Maintainer:** Arcanine Development Team
